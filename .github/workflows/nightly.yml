name: Nightly Build

on:
  schedule:
    # Run at 2 AM UTC every day
    # - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  extended-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        sevenzip_repo: 
          - { url: 'ip7z/7zip', name: 'ip7z' }
          - { url: 'mcmilk/7-Zip-zstd', name: 'mcmilk' }
        build_system: [make, cmake]
        exclude:
          # Skip make on Windows (use NMAKE via cmake only for simplicity)
          - os: windows-latest
            build_system: make
    
    name: Nightly (${{ matrix.os }}, ${{ matrix.build_system }}, ${{ matrix.sevenzip_repo.name }})
    
    steps:
    - name: Checkout libsevenzip
      uses: actions/checkout@v4
      with:
        path: libsevenzip

    - name: Checkout 7-Zip dependency
      uses: actions/checkout@v4
      with:
        repository: ${{ matrix.sevenzip_repo.url }}
        path: 7zip

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build valgrind

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja

    - name: Setup MSVC (Windows)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v2

    # Make/NMAKE builds
    - name: Build with Make (Unix)
      if: matrix.build_system == 'make' && runner.os != 'Windows'
      working-directory: libsevenzip
      run: |
        make 7zip SEVENZIPSRC=../7zip DEBUG=1
        make tests SEVENZIPSRC=../7zip DEBUG=1
        make examples SEVENZIPSRC=../7zip DEBUG=1

    # CMake builds
    - name: Configure CMake
      if: matrix.build_system == 'cmake'
      working-directory: libsevenzip
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          cmake -B build -A x64 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DSEVENZIPSRC=../7zip
        else
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DSEVENZIPSRC=../7zip
        fi

    - name: Build with CMake
      if: matrix.build_system == 'cmake'
      working-directory: libsevenzip
      run: cmake --build build --config RelWithDebInfo

    # Tests
    - name: Run tests (Make, Unix)
      if: matrix.build_system == 'make' && runner.os != 'Windows'
      working-directory: libsevenzip
      run: ./tests/tests

    - name: Run tests (CMake, Unix)
      if: matrix.build_system == 'cmake' && runner.os != 'Windows'
      working-directory: libsevenzip/build
      run: ctest --output-on-failure -C RelWithDebInfo

    - name: Run tests (CMake, Windows)
      if: matrix.build_system == 'cmake' && runner.os == 'Windows'
      working-directory: libsevenzip/build
      run: ctest --output-on-failure -C RelWithDebInfo

    # Memory checks (Linux only, Make only, to keep it manageable)
    - name: Memory check with Valgrind
      if: matrix.build_system == 'make' && runner.os == 'Linux'
      working-directory: libsevenzip
      run: |
        valgrind --leak-check=full --error-exitcode=1 --show-leak-kinds=all ./tests/tests

  # Build documentation or additional artifacts
  docs-and-release:
    runs-on: ubuntu-latest
    needs: extended-test
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Generate build info
      run: |
        echo "Nightly build completed successfully on $(date)" > build-info.txt
        echo "Commit: ${{ github.sha }}" >> build-info.txt
        echo "Branch: ${{ github.ref }}" >> build-info.txt

    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: nightly-build-info
        path: build-info.txt
        retention-days: 30

  notify:
    runs-on: ubuntu-latest
    needs: extended-test
    if: failure() && github.event_name == 'schedule'
    
    steps:
    - name: Nightly build failed
      run: |
        echo "::error::Nightly build failed! Check the logs for details."
        # Add notification logic here (email, Slack, etc.) if needed
